<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="JMRC Time">
    <title>JMRC Time Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f5f5f7;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .header {
            background: linear-gradient(135deg, #001f3f 0%, #003d7a 100%);
            color: white;
            padding: 20px 15px 15px 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header-logo {
            max-width: 120px;
            height: auto;
            display: block;
            margin: 0 auto 10px auto;
        }

        .header h1 {
            font-size: 1.3em;
            text-align: center;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 0.75em;
            text-align: center;
            opacity: 0.9;
        }

        .content {
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #001f3f;
            font-size: 1.2em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #001f3f;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            background: #f9f9f9;
            transition: all 0.3s;
        }

        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: #001f3f;
            background: white;
        }

        button {
            background: #001f3f;
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            margin-bottom: 10px;
            transition: all 0.3s;
            touch-action: manipulation;
        }

        button:active {
            transform: scale(0.98);
            background: #003d7a;
        }

        button.secondary {
            background: #6c757d;
        }

        button.danger {
            background: #dc3545;
        }

        button.success {
            background: #28a745;
        }

        .stopwatch-display {
            font-size: 3.5em;
            text-align: center;
            font-weight: bold;
            color: #001f3f;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            background: #f0f0f0;
            padding: 20px;
            border-radius: 15px;
        }

        .timer-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .project-item, .task-item {
            background: #f9f9f9;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border-left: 4px solid #001f3f;
        }

        .project-item h3, .task-item h4 {
            color: #001f3f;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .project-item p, .task-item p {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .subtask {
            margin-left: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-top: 8px;
            border-left: 3px solid #6c757d;
        }

        .time-display {
            display: inline-block;
            background: #001f3f;
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .entry-item {
            background: white;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 10px;
            border-left: 4px solid #001f3f;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .entry-title {
            flex: 1;
            font-weight: 600;
            color: #001f3f;
            font-size: 1em;
        }

        .entry-time {
            text-align: right;
        }

        .entry-meta {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 8px;
        }

        .entry-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .entry-actions button {
            padding: 10px;
            font-size: 14px;
            margin-bottom: 0;
        }

        .edited-marker {
            color: #dc3545;
            font-weight: bold;
            margin-left: 5px;
        }

        .original-time {
            text-decoration: line-through;
            color: #999;
            font-size: 0.85em;
            display: block;
            margin-bottom: 3px;
        }

        .edit-reason {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.85em;
            border-radius: 5px;
        }

        .week-selector {
            max-height: 300px;
            overflow-y: auto;
        }

        .week-button {
            padding: 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s;
            text-align: left;
        }

        .week-button:active {
            transform: scale(0.98);
        }

        .week-button.active {
            background: #001f3f;
            color: white;
            border-color: #001f3f;
        }

        .summary {
            background: linear-gradient(135deg, #001f3f 0%, #003d7a 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .summary h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.3);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #ddd;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .nav-item {
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            background: white;
            color: #666;
            font-size: 0.7em;
            border-radius: 0;
            margin: 0;
        }

        .nav-item:active {
            background: #f0f0f0;
            transform: none;
        }

        .nav-item.active {
            color: #001f3f;
            font-weight: 600;
        }

        .nav-icon {
            font-size: 1.5em;
            margin-bottom: 4px;
            display: block;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            background: white;
            margin: 20px;
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            margin: 20px auto;
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ddd;
            position: relative;
        }

        .modal-header h2 {
            color: #001f3f;
            font-size: 1.3em;
        }

        .close-modal {
            position: absolute;
            right: 0;
            top: 0;
            font-size: 30px;
            cursor: pointer;
            color: #666;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quick-action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .quick-action-btn {
            padding: 20px;
            background: white;
            border: 2px solid #001f3f;
            border-radius: 15px;
            color: #001f3f;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-action-btn:active {
            background: #001f3f;
            color: white;
        }

        .list-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 10px;
            opacity: 0.3;
        }

        /* iOS safe area */
        @supports(padding: max(0px)) {
            body {
                padding-bottom: max(80px, env(safe-area-inset-bottom));
            }
            
            .bottom-nav {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        .section-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
            padding-left: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://iili.io/Ksm72AQ.png" alt="JMRC LIMITED LOGO" class="header-logo">
        <h1>‚è±Ô∏è JMRC Time Tracker</h1>
        <p>Time and Task Management</p>
    </div>

    <div class="content">
        <!-- Home Tab -->
        <div id="home" class="tab-content active">
            <div class="card">
                <h2>Employee Info</h2>
                <div class="input-group">
                    <label>Your Name</label>
                    <input type="text" id="employeeName" placeholder="Enter your name">
                </div>
                <button onclick="saveEmployeeName()" class="success">Save Name</button>
            </div>

            <div class="card">
                <h2>Current Week</h2>
                <div class="input-group">
                    <label>Select Work Week</label>
                    <select id="weekDropdown" onchange="selectWeekFromDropdown()">
                    </select>
                </div>
                <div id="currentWeekDisplay" style="text-align: center; padding: 15px; background: #f0f0f0; border-radius: 10px; font-weight: bold; color: #001f3f; margin-top: 10px;"></div>
            </div>

            <div class="card">
                <h2>Quick Actions</h2>
                <div class="quick-action-grid">
                    <button onclick="openModal('projectModal')" style="margin: 0;">+ Project</button>
                    <button onclick="openModal('taskModal')" class="secondary" style="margin: 0;">+ Task</button>
                </div>
                <button onclick="exportData()" class="success">üìÑ Export PDF Report</button>
            </div>
        </div>

        <!-- Track Tab -->
        <div id="track" class="tab-content">
            <div class="card">
                <h2>‚è±Ô∏è Stopwatch Timer</h2>
                <div class="input-group">
                    <label>Project</label>
                    <select id="stopwatchProject">
                        <option value="">Select project...</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Task</label>
                    <select id="stopwatchTask">
                        <option value="">Select task...</option>
                    </select>
                </div>
                <div class="stopwatch-display" id="stopwatchDisplay">00:00:00</div>
                <div class="timer-controls">
                    <button onclick="startStopwatch()" class="success">‚ñ∂ Start</button>
                    <button onclick="pauseStopwatch()" class="secondary">‚è∏ Pause</button>
                    <button onclick="stopStopwatch()" class="success">üíæ Save</button>
                    <button onclick="resetStopwatch()">üîÑ Reset</button>
                </div>
            </div>

            <div class="card">
                <h2>‚úèÔ∏è Manual Entry</h2>
                <div class="input-group">
                    <label>Project</label>
                    <select id="manualProject">
                        <option value="">Select project...</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Task</label>
                    <select id="manualTask">
                        <option value="">Select task...</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="input-group">
                        <label>Hours</label>
                        <input type="number" id="manualHours" min="0" max="24" value="0">
                    </div>
                    <div class="input-group">
                        <label>Minutes</label>
                        <input type="number" id="manualMinutes" min="0" max="59" value="0">
                    </div>
                </div>
                <div class="input-group">
                    <label>Date</label>
                    <input type="date" id="manualDate">
                </div>
                <div class="input-group">
                    <label>Notes</label>
                    <textarea id="manualNotes" rows="3" placeholder="Optional notes..."></textarea>
                </div>
                <button onclick="saveManualEntry()" class="success">üíæ Save Entry</button>
            </div>
        </div>

        <!-- Projects Tab -->
        <div id="projects" class="tab-content">
            <div class="card">
                <h2>üìÅ My Projects</h2>
                <button onclick="openModal('projectModal')" style="margin-bottom: 15px;">+ Add New Project</button>
                <div class="list-container" id="projectList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÅ</div>
                        <p>No projects yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tasks Tab -->
        <div id="tasks" class="tab-content">
            <div class="card">
                <h2>‚úì My Tasks</h2>
                <button onclick="openModal('taskModal')" style="margin-bottom: 15px;">+ Add New Task</button>
                <div class="list-container" id="taskList">
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úì</div>
                        <p>No tasks yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <div class="card">
                <h2>üìä Time Summary</h2>
                <div class="section-label">
                    <span class="edited-marker">*</span> = Edited entry
                </div>
                <div id="reportContent">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <p>No time entries yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('home')">
            <span class="nav-icon">üè†</span>
            Home
        </button>
        <button class="nav-item" onclick="switchTab('track')">
            <span class="nav-icon">‚è±Ô∏è</span>
            Track
        </button>
        <button class="nav-item" onclick="switchTab('projects')">
            <span class="nav-icon">üìÅ</span>
            Projects
        </button>
        <button class="nav-item" onclick="switchTab('tasks')">
            <span class="nav-icon">‚úì</span>
            Tasks
        </button>
        <button class="nav-item" onclick="switchTab('reports')">
            <span class="nav-icon">üìä</span>
            Reports
        </button>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Project</h2>
                <span class="close-modal" onclick="closeModal('projectModal')">&times;</span>
            </div>
            <div class="input-group">
                <label>Project Name</label>
                <input type="text" id="newProjectName" placeholder="Enter project name">
            </div>
            <div class="input-group">
                <label>Description</label>
                <textarea id="newProjectDesc" rows="3" placeholder="Enter description"></textarea>
            </div>
            <button onclick="addProject()" class="success">Add Project</button>
            <button onclick="closeModal('projectModal')" class="secondary">Cancel</button>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Task</h2>
                <span class="close-modal" onclick="closeModal('taskModal')">&times;</span>
            </div>
            <div class="input-group">
                <label>Task Type</label>
                <select id="taskType" onchange="toggleProjectSelect()">
                    <option value="independent">Independent Task</option>
                    <option value="project">Project Sub-task</option>
                </select>
            </div>
            <div class="input-group" id="projectSelectGroup" style="display: none;">
                <label>Select Project</label>
                <select id="taskProject">
                    <option value="">Select a project...</option>
                </select>
            </div>
            <div class="input-group">
                <label>Task Name</label>
                <input type="text" id="newTaskName" placeholder="Enter task name">
            </div>
            <div class="input-group">
                <label>Description</label>
                <textarea id="newTaskDesc" rows="3" placeholder="Enter description"></textarea>
            </div>
            <button onclick="addTask()" class="success">Add Task</button>
            <button onclick="closeModal('taskModal')" class="secondary">Cancel</button>
        </div>
    </div>

    <!-- Edit Entry Modal -->
    <div id="editEntryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Time Entry</h2>
                <span class="close-modal" onclick="closeModal('editEntryModal')">&times;</span>
            </div>
            <div style="background: #f0f0f0; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                <strong>Original Time:</strong> <span id="origTime"></span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="input-group">
                    <label>New Hours</label>
                    <input type="number" id="editHours" min="0" max="24" value="0">
                </div>
                <div class="input-group">
                    <label>New Minutes</label>
                    <input type="number" id="editMinutes" min="0" max="59" value="0">
                </div>
            </div>
            <div class="input-group">
                <label>Reason for Edit (Required)</label>
                <textarea id="editReason" rows="3" placeholder="Why are you editing this entry?" required></textarea>
            </div>
            <button onclick="saveEditedEntry()" class="success">Save Changes</button>
            <button onclick="closeModal('editEntryModal')" class="secondary">Cancel</button>
        </div>
    </div>

    <script>
        // Data Storage
        let appData = {
            employee: '',
            projects: [],
            tasks: [],
            timeEntries: [],
            currentWeek: getCurrentWeek(),
            weeks: generateWeeks()
        };

        // Stopwatch variables
        let stopwatchInterval = null;
        let stopwatchSeconds = 0;
        let stopwatchRunning = false;

        // Edit tracking
        let currentEditingEntryId = null;

        // Initialize app
        function init() {
            loadData();
            updateUI();
            populateWeekDropdown();
            updateCurrentWeekDisplay();
            setTodayDate();
        }

        // Generate weeks for the entire year
        function generateWeeks() {
            const weeks = [];
            const year = new Date().getFullYear();
            const firstDay = new Date(year, 0, 1);
            const lastDay = new Date(year, 11, 31);
            
            let currentDate = new Date(firstDay);
            currentDate.setDate(currentDate.getDate() - currentDate.getDay() + 1);
            
            let weekNumber = 1;
            while (currentDate <= lastDay) {
                const weekStart = new Date(currentDate);
                const weekEnd = new Date(currentDate);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                weeks.push({
                    number: weekNumber,
                    start: weekStart.toISOString().split('T')[0],
                    end: weekEnd.toISOString().split('T')[0],
                    label: `Week ${weekNumber} (${formatDate(weekStart)} - ${formatDate(weekEnd)})`
                });
                
                currentDate.setDate(currentDate.getDate() + 7);
                weekNumber++;
            }
            
            return weeks;
        }

        function getCurrentWeek() {
            const now = new Date();
            const weeks = generateWeeks();
            for (let week of weeks) {
                const start = new Date(week.start);
                const end = new Date(week.end);
                if (now >= start && now <= end) {
                    return week.number;
                }
            }
            return 1;
        }

        function populateWeekDropdown() {
            const dropdown = document.getElementById('weekDropdown');
            dropdown.innerHTML = '';
            
            appData.weeks.forEach(week => {
                const option = document.createElement('option');
                option.value = week.number;
                option.textContent = `Week ${week.number} - ${formatDate(new Date(week.start))} to ${formatDate(new Date(week.end))}`;
                if (week.number === appData.currentWeek) {
                    option.selected = true;
                }
                dropdown.appendChild(option);
            });
        }

        function selectWeekFromDropdown() {
            const dropdown = document.getElementById('weekDropdown');
            const weekNumber = parseInt(dropdown.value);
            selectWeek(weekNumber);
        }

        function selectWeek(weekNumber) {
            appData.currentWeek = weekNumber;
            saveData();
            populateWeekDropdown();
            updateCurrentWeekDisplay();
            updateUI();
        }

        function updateCurrentWeekDisplay() {
            const week = appData.weeks.find(w => w.number === appData.currentWeek);
            if (week) {
                document.getElementById('currentWeekDisplay').textContent = week.label;
            }
        }

        function formatDate(date) {
            const d = new Date(date);
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${month}/${day}`;
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('manualDate').value = today;
        }

        // Save/Load Data
        function saveData() {
            localStorage.setItem('timeTrackingDataMobile', JSON.stringify(appData));
        }

        function loadData() {
            const saved = localStorage.getItem('timeTrackingDataMobile');
            if (saved) {
                const loaded = JSON.parse(saved);
                appData = { ...appData, ...loaded };
                appData.weeks = generateWeeks();
                
                // Migrate old entries
                appData.timeEntries = appData.timeEntries.map(entry => ({
                    ...entry,
                    edited: entry.edited || false,
                    originalHours: entry.originalHours !== undefined ? entry.originalHours : null,
                    originalMinutes: entry.originalMinutes !== undefined ? entry.originalMinutes : null,
                    editReason: entry.editReason || null
                }));
                
                document.getElementById('employeeName').value = appData.employee || '';
            }
        }

        // Employee
        function saveEmployeeName() {
            appData.employee = document.getElementById('employeeName').value;
            saveData();
            alert('‚úì Employee name saved!');
        }

        // Projects
        function addProject() {
            const name = document.getElementById('newProjectName').value.trim();
            const desc = document.getElementById('newProjectDesc').value.trim();
            
            if (!name) {
                alert('‚ö†Ô∏è Please enter a project name');
                return;
            }
            
            const project = {
                id: Date.now(),
                name: name,
                description: desc,
                created: new Date().toISOString()
            };
            
            appData.projects.push(project);
            saveData();
            updateUI();
            closeModal('projectModal');
            
            document.getElementById('newProjectName').value = '';
            document.getElementById('newProjectDesc').value = '';
            
            alert('‚úì Project added!');
        }

        function deleteProject(id) {
            if (confirm('Delete this project and all associated data?')) {
                appData.projects = appData.projects.filter(p => p.id !== id);
                appData.tasks = appData.tasks.filter(t => t.projectId !== id);
                appData.timeEntries = appData.timeEntries.filter(e => e.projectId !== id);
                saveData();
                updateUI();
            }
        }

        // Tasks
        function toggleProjectSelect() {
            const type = document.getElementById('taskType').value;
            const group = document.getElementById('projectSelectGroup');
            group.style.display = type === 'project' ? 'block' : 'none';
        }

        function addTask() {
            const type = document.getElementById('taskType').value;
            const name = document.getElementById('newTaskName').value.trim();
            const desc = document.getElementById('newTaskDesc').value.trim();
            const projectId = type === 'project' ? parseInt(document.getElementById('taskProject').value) : null;
            
            if (!name) {
                alert('‚ö†Ô∏è Please enter a task name');
                return;
            }
            
            if (type === 'project' && !projectId) {
                alert('‚ö†Ô∏è Please select a project');
                return;
            }
            
            const task = {
                id: Date.now(),
                name: name,
                description: desc,
                type: type,
                projectId: projectId,
                created: new Date().toISOString()
            };
            
            appData.tasks.push(task);
            saveData();
            updateUI();
            closeModal('taskModal');
            
            document.getElementById('newTaskName').value = '';
            document.getElementById('newTaskDesc').value = '';
            document.getElementById('taskType').value = 'independent';
            toggleProjectSelect();
            
            alert('‚úì Task added!');
        }

        function deleteTask(id) {
            if (confirm('Delete this task?')) {
                appData.tasks = appData.tasks.filter(t => t.id !== id);
                appData.timeEntries = appData.timeEntries.filter(e => e.taskId !== id);
                saveData();
                updateUI();
            }
        }

        // Stopwatch
        function startStopwatch() {
            if (!stopwatchRunning) {
                stopwatchRunning = true;
                stopwatchInterval = setInterval(() => {
                    stopwatchSeconds++;
                    updateStopwatchDisplay();
                }, 1000);
            }
        }

        function pauseStopwatch() {
            stopwatchRunning = false;
            if (stopwatchInterval) {
                clearInterval(stopwatchInterval);
                stopwatchInterval = null;
            }
        }

        function resetStopwatch() {
            pauseStopwatch();
            stopwatchSeconds = 0;
            updateStopwatchDisplay();
        }

        function stopStopwatch() {
            if (stopwatchSeconds === 0) {
                alert('‚ö†Ô∏è No time to save!');
                return;
            }
            
            const projectId = parseInt(document.getElementById('stopwatchProject').value);
            const taskId = parseInt(document.getElementById('stopwatchTask').value);
            
            if (!projectId && !taskId) {
                alert('‚ö†Ô∏è Please select a project or task');
                return;
            }
            
            const hours = Math.floor(stopwatchSeconds / 3600);
            const minutes = Math.floor((stopwatchSeconds % 3600) / 60);
            
            const entry = {
                id: Date.now(),
                projectId: projectId || null,
                taskId: taskId || null,
                hours: hours,
                minutes: minutes,
                date: new Date().toISOString().split('T')[0],
                week: appData.currentWeek,
                method: 'stopwatch',
                notes: 'Tracked with stopwatch',
                created: new Date().toISOString(),
                edited: false,
                originalHours: null,
                originalMinutes: null,
                editReason: null
            };
            
            appData.timeEntries.push(entry);
            saveData();
            updateUI();
            
            resetStopwatch();
            alert('‚úì Time entry saved!');
        }

        function updateStopwatchDisplay() {
            const hours = Math.floor(stopwatchSeconds / 3600);
            const minutes = Math.floor((stopwatchSeconds % 3600) / 60);
            const seconds = stopwatchSeconds % 60;
            
            document.getElementById('stopwatchDisplay').textContent = 
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // Manual Entry
        function saveManualEntry() {
            const projectId = parseInt(document.getElementById('manualProject').value);
            const taskId = parseInt(document.getElementById('manualTask').value);
            const hours = parseInt(document.getElementById('manualHours').value) || 0;
            const minutes = parseInt(document.getElementById('manualMinutes').value) || 0;
            const date = document.getElementById('manualDate').value;
            const notes = document.getElementById('manualNotes').value.trim();
            
            if (!projectId && !taskId) {
                alert('‚ö†Ô∏è Please select a project or task');
                return;
            }
            
            if (hours === 0 && minutes === 0) {
                alert('‚ö†Ô∏è Please enter time spent');
                return;
            }
            
            if (!date) {
                alert('‚ö†Ô∏è Please select a date');
                return;
            }
            
            const entry = {
                id: Date.now(),
                projectId: projectId || null,
                taskId: taskId || null,
                hours: hours,
                minutes: minutes,
                date: date,
                week: appData.currentWeek,
                method: 'manual',
                notes: notes,
                created: new Date().toISOString(),
                edited: false,
                originalHours: null,
                originalMinutes: null,
                editReason: null
            };
            
            appData.timeEntries.push(entry);
            saveData();
            updateUI();
            
            document.getElementById('manualHours').value = '0';
            document.getElementById('manualMinutes').value = '0';
            document.getElementById('manualNotes').value = '';
            
            alert('‚úì Time entry saved!');
        }

        // Edit Entry Functions
        function openEditEntry(entryId) {
            const entry = appData.timeEntries.find(e => e.id === entryId);
            if (!entry) return;
            
            currentEditingEntryId = entryId;
            
            const originalHours = entry.originalHours !== null ? entry.originalHours : entry.hours;
            const originalMinutes = entry.originalMinutes !== null ? entry.originalMinutes : entry.minutes;
            document.getElementById('origTime').textContent = `${originalHours}h ${originalMinutes}m`;
            
            document.getElementById('editHours').value = entry.hours;
            document.getElementById('editMinutes').value = entry.minutes;
            document.getElementById('editReason').value = '';
            
            openModal('editEntryModal');
        }

        function saveEditedEntry() {
            const entry = appData.timeEntries.find(e => e.id === currentEditingEntryId);
            if (!entry) return;
            
            const newHours = parseInt(document.getElementById('editHours').value) || 0;
            const newMinutes = parseInt(document.getElementById('editMinutes').value) || 0;
            const reason = document.getElementById('editReason').value.trim();
            
            if (newHours === 0 && newMinutes === 0) {
                alert('‚ö†Ô∏è Please enter valid time');
                return;
            }
            
            if (!reason) {
                alert('‚ö†Ô∏è Please provide a reason for editing');
                return;
            }
            
            if (entry.hours === newHours && entry.minutes === newMinutes) {
                alert('‚ö†Ô∏è No changes detected');
                return;
            }
            
            if (!entry.edited) {
                entry.originalHours = entry.hours;
                entry.originalMinutes = entry.minutes;
            }
            
            entry.hours = newHours;
            entry.minutes = newMinutes;
            entry.edited = true;
            entry.editReason = reason;
            entry.editedAt = new Date().toISOString();
            
            saveData();
            updateUI();
            closeModal('editEntryModal');
            
            alert('‚úì Time entry updated!');
        }

        function deleteEntry(entryId) {
            if (confirm('Delete this time entry?')) {
                appData.timeEntries = appData.timeEntries.filter(e => e.id !== entryId);
                saveData();
                updateUI();
            }
        }

        // UI Updates
        function updateUI() {
            updateProjectList();
            updateTaskList();
            updateProjectSelects();
            updateTaskSelects();
            updateReports();
        }

        function updateProjectList() {
            const container = document.getElementById('projectList');
            if (appData.projects.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÅ</div>
                        <p>No projects yet</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = appData.projects.map(project => {
                const projectTasks = appData.tasks.filter(t => t.projectId === project.id);
                const totalTime = calculateProjectTime(project.id);
                
                return `
                    <div class="project-item">
                        <h3>${project.name}</h3>
                        <p>${project.description || 'No description'}</p>
                        <p><strong>Total Time:</strong> <span class="time-display">${totalTime}</span></p>
                        <p><strong>Sub-tasks:</strong> ${projectTasks.length}</p>
                        ${projectTasks.length > 0 ? `
                            <div style="margin-top: 10px;">
                                ${projectTasks.map(task => `
                                    <div class="subtask">
                                        <strong>${task.name}</strong>
                                        <p style="margin: 5px 0; font-size: 0.85em;">${task.description || ''}</p>
                                        <span class="time-display" style="font-size: 0.8em;">${calculateTaskTime(task.id)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        <button onclick="deleteProject(${project.id})" class="danger" style="margin-top: 10px;">Delete Project</button>
                    </div>
                `;
            }).join('');
        }

        function updateTaskList() {
            const container = document.getElementById('taskList');
            const independentTasks = appData.tasks.filter(t => t.type === 'independent');
            
            if (appData.tasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úì</div>
                        <p>No tasks yet</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <h3 style="color: #001f3f; margin-bottom: 15px; font-size: 1.1em;">Independent Tasks</h3>
                ${independentTasks.length === 0 ? '<p style="color: #999; text-align: center; padding: 20px;">No independent tasks</p>' : 
                    independentTasks.map(task => `
                        <div class="task-item">
                            <h4>${task.name}</h4>
                            <p>${task.description || 'No description'}</p>
                            <p><strong>Total Time:</strong> <span class="time-display">${calculateTaskTime(task.id)}</span></p>
                            <button onclick="deleteTask(${task.id})" class="danger" style="margin-top: 10px;">Delete Task</button>
                        </div>
                    `).join('')
                }
            `;
        }

        function updateProjectSelects() {
            const selects = [
                document.getElementById('stopwatchProject'),
                document.getElementById('manualProject'),
                document.getElementById('taskProject')
            ];
            
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select a project...</option>' +
                    appData.projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                select.value = currentValue;
            });
        }

        function updateTaskSelects() {
            const stopwatchSelect = document.getElementById('stopwatchTask');
            const manualSelect = document.getElementById('manualTask');
            
            const taskOptions = appData.tasks.map(t => {
                const project = appData.projects.find(p => p.id === t.projectId);
                const label = project ? `${t.name} (${project.name})` : t.name;
                return `<option value="${t.id}">${label}</option>`;
            }).join('');
            
            [stopwatchSelect, manualSelect].forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select a task...</option>' + taskOptions;
                select.value = currentValue;
            });
        }

        function updateReports() {
            const container = document.getElementById('reportContent');
            
            if (appData.timeEntries.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <p>No time entries yet</p>
                    </div>
                `;
                return;
            }
            
            const weekEntries = appData.timeEntries.filter(e => e.week === appData.currentWeek);
            const totalMinutes = weekEntries.reduce((sum, e) => sum + (e.hours * 60 + e.minutes), 0);
            
            const projectSummary = {};
            const taskSummary = {};
            
            weekEntries.forEach(entry => {
                if (entry.projectId) {
                    projectSummary[entry.projectId] = (projectSummary[entry.projectId] || 0) + (entry.hours * 60 + entry.minutes);
                }
                if (entry.taskId) {
                    taskSummary[entry.taskId] = (taskSummary[entry.taskId] || 0) + (entry.hours * 60 + entry.minutes);
                }
            });
            
            container.innerHTML = `
                <div class="summary">
                    <h3>Week ${appData.currentWeek} Summary</h3>
                    <div class="summary-item">
                        <span><strong>Total Time:</strong></span>
                        <span>${formatMinutes(totalMinutes)}</span>
                    </div>
                    <div class="summary-item">
                        <span><strong>Total Entries:</strong></span>
                        <span>${weekEntries.length}</span>
                    </div>
                </div>
                
                ${Object.keys(projectSummary).length > 0 ? `
                    <h3 style="margin: 20px 0 15px 0; color: #001f3f; font-size: 1.1em;">Time by Project</h3>
                    ${Object.entries(projectSummary).map(([id, minutes]) => {
                        const project = appData.projects.find(p => p.id === parseInt(id));
                        return `
                            <div style="background: #f9f9f9; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <strong>${project ? project.name : 'Unknown'}</strong>
                                <span class="time-display">${formatMinutes(minutes)}</span>
                            </div>
                        `;
                    }).join('')}
                ` : ''}
                
                ${Object.keys(taskSummary).length > 0 ? `
                    <h3 style="margin: 20px 0 15px 0; color: #001f3f; font-size: 1.1em;">Time by Task</h3>
                    ${Object.entries(taskSummary).map(([id, minutes]) => {
                        const task = appData.tasks.find(t => t.id === parseInt(id));
                        return `
                            <div style="background: #f9f9f9; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <strong>${task ? task.name : 'Unknown'}</strong>
                                <span class="time-display">${formatMinutes(minutes)}</span>
                            </div>
                        `;
                    }).join('')}
                ` : ''}
                
                <h3 style="margin: 20px 0 15px 0; color: #001f3f; font-size: 1.1em;">All Entries</h3>
                ${weekEntries.map(entry => {
                    const project = entry.projectId ? appData.projects.find(p => p.id === entry.projectId) : null;
                    const task = entry.taskId ? appData.tasks.find(t => t.id === entry.taskId) : null;
                    
                    return `
                        <div class="entry-item">
                            <div class="entry-header">
                                <div class="entry-title">
                                    ${project ? project.name : ''} ${task ? '- ' + task.name : ''}
                                    ${entry.edited ? '<span class="edited-marker">*</span>' : ''}
                                </div>
                                <div class="entry-time">
                                    ${entry.edited ? `<span class="original-time">${entry.originalHours}h ${entry.originalMinutes}m</span>` : ''}
                                    <span class="time-display">${entry.hours}h ${entry.minutes}m</span>
                                </div>
                            </div>
                            <div class="entry-meta">${entry.date} ‚Ä¢ ${entry.method}</div>
                            ${entry.notes ? `<div class="entry-meta">${entry.notes}</div>` : ''}
                            ${entry.edited ? `
                                <div class="edit-reason">
                                    <strong>Edit Reason:</strong> ${entry.editReason}<br>
                                    <small>Original: ${entry.originalHours}h ${entry.originalMinutes}m ‚Üí Current: ${entry.hours}h ${entry.minutes}m</small>
                                </div>
                            ` : ''}
                            <div class="entry-actions">
                                <button onclick="openEditEntry(${entry.id})">‚úèÔ∏è Edit</button>
                                <button onclick="deleteEntry(${entry.id})" class="danger">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        function calculateProjectTime(projectId) {
            const entries = appData.timeEntries.filter(e => e.projectId === projectId);
            const totalMinutes = entries.reduce((sum, e) => sum + (e.hours * 60 + e.minutes), 0);
            return formatMinutes(totalMinutes);
        }

        function calculateTaskTime(taskId) {
            const entries = appData.timeEntries.filter(e => e.taskId === taskId);
            const totalMinutes = entries.reduce((sum, e) => sum + (e.hours * 60 + e.minutes), 0);
            return formatMinutes(totalMinutes);
        }

        function formatMinutes(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}h ${mins}m`;
        }

        // Tabs
        function switchTab(tabName) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Scroll to top when switching tabs
            window.scrollTo(0, 0);
        }

        // Modals
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // Export PDF
        function exportData() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const employee = appData.employee || 'Unknown';
            const week = appData.weeks.find(w => w.number === appData.currentWeek);
            const weekEntries = appData.timeEntries.filter(e => e.week === appData.currentWeek);
            const totalMinutes = weekEntries.reduce((sum, e) => sum + (e.hours * 60 + e.minutes), 0);
            
            let yPos = 20;
            
            // Header
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('JMRC TIME TRACKER', 105, yPos, { align: 'center' });
            
            yPos += 10;
            doc.setFontSize(16);
            doc.text('Time Tracking Report', 105, yPos, { align: 'center' });
            
            yPos += 15;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Employee: ${employee}`, 20, yPos);
            
            yPos += 6;
            doc.text(`Week: ${week ? week.label : appData.currentWeek}`, 20, yPos);
            
            yPos += 6;
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, yPos);
            
            yPos += 10;
            doc.setDrawColor(0, 31, 63);
            doc.line(20, yPos, 190, yPos);
            
            // Summary
            yPos += 10;
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Summary', 20, yPos);
            
            yPos += 8;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total Time: ${formatMinutes(totalMinutes)}`, 20, yPos);
            
            yPos += 6;
            doc.text(`Total Entries: ${weekEntries.length}`, 20, yPos);
            
            yPos += 10;
            doc.line(20, yPos, 190, yPos);
            
            // Entries
            yPos += 10;
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Time Entries', 20, yPos);
            
            yPos += 8;
            doc.setFontSize(9);
            
            weekEntries.forEach((entry, index) => {
                const project = entry.projectId ? appData.projects.find(p => p.id === entry.projectId) : null;
                const task = entry.taskId ? appData.tasks.find(t => t.id === entry.taskId) : null;
                
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFont(undefined, 'bold');
                doc.text(`Entry ${index + 1}:`, 20, yPos);
                
                yPos += 5;
                doc.setFont(undefined, 'normal');
                doc.text(`Date: ${entry.date}`, 25, yPos);
                
                yPos += 5;
                doc.text(`Project: ${project ? project.name : 'N/A'}`, 25, yPos);
                
                yPos += 5;
                doc.text(`Task: ${task ? task.name : 'N/A'}`, 25, yPos);
                
                yPos += 5;
                if (entry.edited) {
                    doc.setTextColor(220, 53, 69);
                    doc.text(`Time: ${entry.hours}h ${entry.minutes}m *EDITED*`, 25, yPos);
                    doc.setTextColor(0, 0, 0);
                    
                    yPos += 5;
                    doc.setFontSize(8);
                    doc.text(`Original: ${entry.originalHours}h ${entry.originalMinutes}m`, 25, yPos);
                    
                    yPos += 4;
                    doc.text(`Edit Reason: ${entry.editReason}`, 25, yPos);
                    
                    yPos += 5;
                    doc.setFontSize(9);
                } else {
                    doc.text(`Time: ${entry.hours}h ${entry.minutes}m`, 25, yPos);
                    yPos += 5;
                }
                
                doc.text(`Method: ${entry.method}`, 25, yPos);
                
                if (entry.notes) {
                    yPos += 5;
                    const notesLines = doc.splitTextToSize(`Notes: ${entry.notes}`, 160);
                    doc.text(notesLines, 25, yPos);
                    yPos += (notesLines.length * 5);
                }
                
                yPos += 8;
                doc.setDrawColor(200, 200, 200);
                doc.line(20, yPos, 190, yPos);
                yPos += 8;
            });
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
            }
            
            doc.save(`JMRC_Timesheet_Week${appData.currentWeek}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // Initialize on load
        window.onload = init;

        // Prevent pull-to-refresh on mobile
        document.body.addEventListener('touchmove', function(e) {
            if (e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>
